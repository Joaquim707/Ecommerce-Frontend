import React, { useState, useEffect } from "react";
import {
  Box,
  Container,
  Grid,
  Card,
  Typography,
  Button,
  IconButton,
  TextField,
  Checkbox,
  Select,
  MenuItem,
  Divider,
  Collapse,
  CircularProgress,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  FormControl,
  InputLabel,
} from "@mui/material";
import {
  LocalOffer as LocalOfferIcon,
  BookmarkBorder as BookmarkBorderIcon,
  Close as CloseIcon,
  ExpandMore as ExpandMoreIcon,
  ExpandLess as ExpandLessIcon,
} from "@mui/icons-material";
import { Link, useNavigate } from "react-router-dom";

const BagPage = () => {
  const navigate = useNavigate();
  const [cartItems, setCartItems] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [selectedItems, setSelectedItems] = useState(new Set());
  const [showOffers, setShowOffers] = useState(false);
  const [donationAmount, setDonationAmount] = useState(null);

  // Modal states
  const [pincodeModalOpen, setPincodeModalOpen] = useState(false);
  const [sizeModalOpen, setSizeModalOpen] = useState(false);
  const [quantityModalOpen, setQuantityModalOpen] = useState(false);
  const [removeModalOpen, setRemoveModalOpen] = useState(false);
  const [wishlistConfirmModalOpen, setWishlistConfirmModalOpen] = useState(false);

  // Modal data
  const [pinCode, setPinCode] = useState("");
  const [tempPinCode, setTempPinCode] = useState("");
  const [selectedItemForChange, setSelectedItemForChange] = useState(null);
  const [tempSize, setTempSize] = useState("");
  const [tempQuantity, setTempQuantity] = useState(1);

  useEffect(() => {
    fetchCart();
  }, []);

  const fetchCart = async () => {
    try {
      setLoading(true);
      const token = localStorage.getItem("token");
      const res = await fetch("http://localhost:5000/api/cart/", {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });
      const data = await res.json();

      if (!res.ok) throw new Error(data.message || "Failed to load cart");

      setCartItems(data.items || []);
      const allIds = (data.items || []).map(
        (item, idx) =>
          `${item.productId?._id}-${item.size}-${item.color}-${idx}`
      );
      setSelectedItems(new Set(allIds));
      setLoading(false);
    } catch (err) {
      setError(err.message);
      setLoading(false);
    }
  };

  const updateQuantity = async (productId, size, newQty) => {
    if (newQty < 1 || newQty > 6) return;

    try {
      const token = localStorage.getItem("token");
      const res = await fetch("http://localhost:5000/api/cart/update", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ productId, size, qty: newQty }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.message || "Failed to update quantity");
      }

      fetchCart();
    } catch (err) {
      alert(err.message);
    }
  };

  const updateSize = async (productId, oldSize, newSize, color) => {
    try {
      const token = localStorage.getItem("token");

      await fetch("http://localhost:5000/api/cart/remove", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ productId, size: oldSize }),
      });

      const res = await fetch("http://localhost:5000/api/cart/add", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          productId,
          size: newSize,
          color: color || undefined,
        }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.message || "Failed to update size");
      }

      fetchCart();
    } catch (err) {
      alert(err.message);
    }
  };

  const removeItem = async (productId, size) => {
    try {
      const token = localStorage.getItem("token");
      const res = await fetch("http://localhost:5000/api/cart/remove", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ productId, size }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.message || "Failed to remove item");
      }

      fetchCart();
    } catch (err) {
      alert(err.message);
    }
  };

  const addToWishlist = async (productId) => {
    try {
      const token = localStorage.getItem("token");
      const res = await fetch("http://localhost:5000/api/wishlist/add", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ productId }),
      });

      if (!res.ok) {
        const data = await res.json();
        throw new Error(data.message || "Failed to add to wishlist");
      }

      return true;
    } catch (err) {
      console.log(err.message);
      return false;
    }
  };

  const removeSelectedItems = async () => {
    try {
      const itemsToRemove = cartItems.filter((item, idx) => {
        const itemId = `${item.productId?._id}-${item.size}-${item.color}-${idx}`;
        return selectedItems.has(itemId);
      });

      for (const item of itemsToRemove) {
        await removeItem(item.productId._id, item.size);
      }

      setRemoveModalOpen(false);
      fetchCart();
    } catch (err) {
      alert("Failed to remove items");
    }
  };

  const moveSelectedToWishlist = async () => {
    try {
      const itemsToMove = cartItems.filter((item, idx) => {
        const itemId = `${item.productId?._id}-${item.size}-${item.color}-${idx}`;
        return selectedItems.has(itemId);
      });

      for (const item of itemsToMove) {
        await addToWishlist(item.productId._id);
      }

      for (const item of itemsToMove) {
        await removeItem(item.productId._id, item.size);
      }

      setWishlistConfirmModalOpen(false);
      setRemoveModalOpen(false);
      fetchCart();
      alert("Items moved to wishlist successfully!");
    } catch (err) {
      alert("Failed to move items to wishlist");
    }
  };

  const toggleItemSelection = (itemId) => {
    const newSelected = new Set(selectedItems);
    if (newSelected.has(itemId)) {
      newSelected.delete(itemId);
    } else {
      newSelected.add(itemId);
    }
    setSelectedItems(newSelected);
  };

  const toggleAllItems = () => {
    if (selectedItems.size === cartItems.length) {
      setSelectedItems(new Set());
    } else {
      const allIds = cartItems.map(
        (item, idx) =>
          `${item.productId?._id}-${item.size}-${item.color}-${idx}`
      );
      setSelectedItems(new Set(allIds));
    }
  };

  const handleProceedToAddress = () => {
    if (selectedItems.size === 0) {
      alert("Please select items to proceed");
      return;
    }
    
    // Store selected items in localStorage
    const selectedItemsArray = Array.from(selectedItems);
    localStorage.setItem("selectedCartItems", JSON.stringify(selectedItemsArray));
    
    navigate("/address");
  };

  const calculateTotal = () => {
    return cartItems.reduce((total, item, idx) => {
      const itemId = `${item.productId?._id}-${item.size}-${item.color}-${idx}`;
      if (!selectedItems.has(itemId)) return total;
      const price = item.productId?.price || 0;
      return total + price * item.quantity;
    }, 0);
  };

  const calculateMRP = () => {
    return cartItems.reduce((total, item, idx) => {
      const itemId = `${item.productId?._id}-${item.size}-${item.color}-${idx}`;
      if (!selectedItems.has(itemId)) return total;
      const MRP = item.productId?.mrp || item.productId?.price || 0;
      return total + MRP * item.quantity;
    }, 0);
  };

  const calculateDiscount = () => {
    return calculateMRP() - calculateTotal();
  };

  if (loading) {
    return (
      <Box
        sx={{
          minHeight: "100vh",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
        }}
      >
        <Box sx={{ textAlign: "center" }}>
          <CircularProgress sx={{ color: "#ff3f6c" }} size={60} />
          <Typography sx={{ mt: 2, color: "text.secondary" }}>
            Loading your bag...
          </Typography>
        </Box>
      </Box>
    );
  }

  if (error) {
    return (
      <Box
        sx={{
          minHeight: "100vh",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
        }}
      >
        <Box sx={{ textAlign: "center" }}>
          <Typography color="error" sx={{ mb: 2 }}>
            {error}
          </Typography>
          <Button
            variant="contained"
            onClick={fetchCart}
            sx={{ bgcolor: "#ff3f6c", "&:hover": { bgcolor: "#e63960" } }}
          >
            Retry
          </Button>
        </Box>
      </Box>
    );
  }

  if (cartItems.length === 0) {
    return (
      <Box
        sx={{
          minHeight: "100vh",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
        }}
      >
        <Box sx={{ textAlign: "center", maxWidth: 400, px: 2 }}>
          <Box component="img" src="/images/Bag.png" alt="Empty bag" />
          <Typography sx={{ fontWeight: 600, mb: 1, fontSize: "20px" }}>
            Hey, it feels so light!
          </Typography>
          <Typography color="text.secondary" sx={{ mb: 3 }}>
            There is nothing in your bag. Let's add some items.
          </Typography>
          <Button
            variant="contained"
            onClick={() => navigate("/wishlist")}
            sx={{
              bgcolor: "#ff3f6c",
              "&:hover": { bgcolor: "#e63960" },
              px: 4,
              py: 1.5,
            }}
          >
            ADD ITEMS FROM WISHLIST
          </Button>
        </Box>
      </Box>
    );
  }

  const totalMRP = calculateMRP();
  const discount = calculateDiscount();
  const totalAmount = calculateTotal();
  const selectedCount = selectedItems.size;

  return (
    <Container maxWidth="lg" sx={{ py: 3 }}>
      <Grid container spacing={1}>
        <Grid
          item
          xs={12}
          lg={8}
          sx={{
            borderRight: { lg: "1px solid #e0e0e0" },
            pr: { lg: 3 },
          }}
        >
          {/* Delivery Check - Rest of the JSX remains the same until the "PLACE ORDER" button */}
          {/* ... (Keep all the existing JSX for cart items, offers, etc.) ... */}

          {/* Replace the PLACE ORDER button with this: */}
        </Grid>

        {/* Right Section - Price Details */}
        <Grid item xs={12} lg={4}>
          <Card
            sx={{
              p: 2,
              boxShadow: "none",
              position: "sticky",
              top: 16,
            }}
          >
            {/* ... (Keep all existing price details JSX) ... */}

            <Button
              fullWidth
              variant="contained"
              onClick={handleProceedToAddress}
              disabled={selectedCount === 0}
              sx={{
                bgcolor: selectedCount === 0 ? "#bdbdbd" : "#ff3f6c",
                fontWeight: 600,
                py: 1.5,
                "&:hover": { 
                  bgcolor: selectedCount === 0 ? "#bdbdbd" : "#e63960" 
                },
                borderRadius: 0,
                cursor: selectedCount === 0 ? "not-allowed" : "pointer",
              }}
            >
              PLACE ORDER
            </Button>
          </Card>
        </Grid>
      </Grid>

      {/* All the modals remain the same */}
    </Container>
  );
};

export default BagPage;